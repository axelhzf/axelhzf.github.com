
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Play Framework + Google Guice - axelhzf</title>
  <meta name="author" content="Axel Hernández Ferrera">

  
  <meta name="description" content="En el proyecto en el que estoy trabajando actualmente empezamos a utilizar Google Guice. Para quien no lo sepa, Guice es un framework de inyección de &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://axelhzf.github.com/blog/2012/02/02/play-framework-plus-google-guice">

  <script type="text/javascript" src="//use.typekit.net/ixj6oqk.js"></script>
  <script type="text/javascript">Typekit.load()</script>

  <link rel="shortcut icon" href="favicon.ico"/>
  <link href="/stylesheets/main.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="axelhzf" type="application/atom+xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31904298-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>

<hgroup class="header">
    <div class="logo"><a href="/">axelhzf</a></div>
</hgroup>



<nav role="navigation"><ul class="main-navigation">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/tutorials">Tutorials</a></li>
    <li><a href="/talks">Talks</a></li>
    <li><a href="/experiments">Experiments</a></li>
    <li><a href="http://twitter.com/axelhzf" target="_blank">Twitter</a></li>
    <li><a href="http://www.github.com/axelhzf" target="_blank">Github</a></li>
    <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank">RSS</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content" class="container">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Play Framework + Google Guice</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-02T22:18:00+00:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>En el proyecto en el que estoy trabajando actualmente empezamos a utilizar Google Guice. Para quien no lo sepa, Guice es un framework de inyección de dependencias. La idea básica de la inyección de dependencias consiste en sumistrar a una clase sus dependencias, en lugar de que sea esta quien tenga que instanciarlas.</p>

<p>Play cuenta con un módulo para integrar Guice:</p>

<p><a href="">http://www.playframework.org/modules/guice-1.2/home</a></p>

<p>Además de la propia documentación del módulo, está este post de <a href="http://www.twitter.com/_felipera">@_felipera</a> que te puede ayudar a dar los primeros pasos:</p>

<p><a href="">http://geeks.aretotally.in/dependency-injection-with-play-framework-and-google-guice</a></p>

<!-- more -->


<p>Los pasos para empezar a utilizar Guice en tu proyecto play son:</p>

<ul>
<li>Añadir la dependencia del módulo:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require:
</span><span class='line'>- play
</span><span class='line'>- play -> guice 1.2</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Descargar las dependencias</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>play deps
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Crear una nueva clase que será la que se inyectará en el controlador.</li>
</ul>


<figure class='code'><figcaption><span>services.MyService.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">services</span><span class="o">;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyService</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>services.MyServiceImpl.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">services</span><span class="o">;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServiceImpl</span> <span class="kd">implements</span> <span class="n">MyService</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">MyServiceImpl</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">play</span><span class="o">.</span><span class="na">Logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Constructor!&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">play</span><span class="o">.</span><span class="na">Logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Configurar el inyector de dependencias</li>
</ul>


<figure class='code'><figcaption><span>config.GuiceConfig.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">config</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceConfig</span> <span class="kd">extends</span> <span class="n">GuiceSupport</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="n">Injector</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="n">AbstractModule</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="nd">@Override</span>
</span><span class='line'>            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">bind</span><span class="o">(</span><span class="n">MyService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>De esta forma se configura la clase como un singleton. Cada vez que una clase tenga la dependencia de MyService se inyectará la misma instancia de MyServiceImpl.</p>

<ul>
<li>Para inyectar la clase se utiliza la anotación @Inject</li>
</ul>


<figure class='code'><figcaption><span>controllers.Application.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">controllers</span><span class="o">;</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="kd">extends</span> <span class="n">Controller</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">MyService</span> <span class="n">myService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">myService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">();</span>
</span><span class='line'>            <span class="n">render</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ya con esto está el servicio inyectado en el controlador.</p>

<p>Mi siguiente paso fue crear un test y es aquí cuando me encontré una sorpresa:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> play <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="">http://localhost:9000/@tests</a></p>

<p>Compilation error! El problema está en que el módulo tiene una carpeta que se llama test. Esta carpeta en vez de tener algunos tests unitarios o funcionales, lo que tiene son 3 aplicaciones de ejemplo. Lo normal hubiera sido seguir la convención de play que es poner este tipo de aplicaciones en la carpeta &#8216;samples-and-tests&#8217;.</p>

<p>Hice un fork del proyeto para renombrar esta carpeta</p>

<p><a href="">https://github.com/axelhzf/play-guice-module</a></p>

<p>También hice un pull-request, pero no he tenido respuesta :(</p>

<p><a href="">https://github.com/pk11/play-guice-module/pull/5</a></p>

<p>Renombrando la carpeta test del módulo sería suficiente para poder ejecutar este test:</p>

<figure class='code'><figcaption><span>InjectTest.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@InjectSupport</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectTest</span> <span class="kd">extends</span> <span class="n">UnitTest</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">MyService</span> <span class="n">myService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">injectOk</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">assertNotNull</span><span class="o">(</span><span class="n">myService</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Por defecto play detecta automáticamente la anotaciones @Inject en las clases que hereden de Controller, Job and Mail. Si queremos poder inyectar dependencias en otras clases debemos anotar la clase con @InjectSupport.</p>

<p>Normalmente nuestros servicios no son tan simples como MyService. Lo normal es tener dependencias entre servicios. Guice resuelve esto analizando las dependencias e instanciando los objetos en el orden adecuado.</p>

<figure class='code'><figcaption><span>services.MyDependentService.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">services</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyDependentService</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHelloWorld</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>services.MyDependentServiceImpl.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">services</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@InjectSupport</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDependentServiceImpl</span> <span class="kd">implements</span> <span class="n">MyDependentService</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">MyService</span> <span class="n">myService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">MyDependentServiceImpl</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">play</span><span class="o">.</span><span class="na">Logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Inicializando MyDependentServiceImpl&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHelloWorld</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">myService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">();</span>
</span><span class='line'>        <span class="n">play</span><span class="o">.</span><span class="na">Logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;world&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>InjectTest.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@InjectSupport</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectTest</span> <span class="kd">extends</span> <span class="n">UnitTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">MyDependentService</span> <span class="n">myDependentService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">injectOk</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">assertNotNull</span><span class="o">(</span><span class="n">myDependentService</span><span class="o">);</span>
</span><span class='line'>        <span class="n">myDependentService</span><span class="o">.</span><span class="na">sayHelloWorld</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Incluimos el binding</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="n">bind</span><span class="o">(</span><span class="n">MyDependentService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyDependentServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y esta es la salida por la consola</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>20:34:39,090 INFO  ~ Inicializando MyServiceImpl
</span><span class='line'>20:34:39,095 INFO  ~ Inicializando MyDependentServiceImpl
</span><span class='line'>20:34:39,095 INFO  ~ Application <span class="s1">&#39;lazySingleton&#39;</span> is now started !
</span><span class='line'>20:34:39,136 INFO  ~ hello
</span><span class='line'>20:34:39,136 INFO  ~ world
</span></code></pre></td></tr></table></div></figure>


<p>Se inicializa primero MyService y luego MyDependentService</p>

<p>Una de las cosas que no me gusta del módulo es que te limita a que los campos que puedes inyectar deben de ser estáticos. Las dependencias por ejemplo me gustaría poder definirlas como parámetros en el constructor. De forma que quede claro que para crear un objeto de la clase MyDependentServiceImpl hace falta un objeto del tipo MyService. Además, utilizar las dependencias mediante constructor facilita hacer tests unitarios.Únicamente es necesario llamar al constructor y pasar como parámetros stubs o mocks de las dependencias. De esta forma no estamos obligados a configurar un inyector.</p>

<p>En la documentación del módulo no vi ninguna referencia a cómo hacer esto. Encontré un artículo que explicaba cómo hacerlo utilizando un Provider:</p>

<p><a href="">http://ericlefevre.net/wordpress/2011/05/08/play-framework-and-guice-use-providers-in-guice-modules/</a></p>

<p>Esta forma funciona correctamente pero más tarde encontré una pregunta en stackoverflow que me dio otra pista:</p>

<p><a href="">http://stackoverflow.com/questions/8435686/does-injector-getinstance-always-call-a-constructor</a></p>

<p>En el <em>Edit</em> pone que se olvidó de anotar con @Inject el constructor. Probé a hacer lo mismo y funcionó:</p>

<figure class='code'><figcaption><span>services.MyDependentServiceImpl.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDependentServiceImpl</span> <span class="kd">implements</span> <span class="n">MyDependentService</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">MyService</span> <span class="n">myService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">MyDependentServiceImpl</span><span class="o">(</span><span class="n">MyService</span> <span class="n">myService</span><span class="o">){</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">myService</span> <span class="o">=</span> <span class="n">myService</span><span class="o">;</span>
</span><span class='line'>        <span class="n">play</span><span class="o">.</span><span class="na">Logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Inicializando MyDependentServiceImpl&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Me faltaba un pequeño detalle para tener google guice configurado perfectamente. En el log se puede ver como los servicios se inicializan cuando se inicia la aplicación.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>21:38:11,801 INFO  ~ Inicializando MyServiceImpl
</span><span class='line'>21:38:11,805 INFO  ~ Inicializando MyDependentServiceImpl
</span><span class='line'>21:38:11,805 INFO  ~ Application <span class="s1">&#39;lazySingleton&#39;</span> is now started !
</span></code></pre></td></tr></table></div></figure>


<p>Cuando la aplicación está en modo producción está bien, es el comportamiento adecuado. Los servicios se deberían instanciar al arrancar la aplicación. Pero cuando estoy en modo desarrollo prefiero que los Singletons se inicialicen bajo demanda (lazy). Puede que haya servicios que tarden en iniciarse y quiero que el tiempo que tarda la aplicación en arrancar en modo desarrollo sea lo más rápido posible.</p>

<p>Buscando en la documentación de google guice veo que está preparado para hacer justamente lo que quiero:</p>

<p><a href="">http://code.google.com/p/google-guice/wiki/Scopes</a></p>

<p>Lo único que hay que hacer es que configurar es el STAGE para indicarle a Guice si estamos en modo desarrollo o en modo producción:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Stage</span> <span class="n">stage</span> <span class="o">=</span> <span class="n">Play</span><span class="o">.</span><span class="na">mode</span><span class="o">.</span><span class="na">isDev</span><span class="o">()?</span><span class="n">Stage</span><span class="o">.</span><span class="na">DEVELOPMENT</span> <span class="o">:</span> <span class="n">Stage</span><span class="o">.</span><span class="na">PRODUCTION</span><span class="o">;</span>
</span><span class='line'><span class="k">return</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="n">stage</span><span class="o">,</span> <span class="k">new</span> <span class="n">AbstractModule</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Al volver a ejecutar el test</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>22:00:03,353 WARN  ~ You<span class="s1">&#39;re running Play! in DEV mode</span>
</span><span class='line'><span class="s1">22:00:04,615 INFO  ~ Connected to jdbc:h2:mem:play;MODE=MYSQL;LOCK_MODE=0</span>
</span><span class='line'><span class="s1">22:00:04,811 INFO  ~ Guice injector created: config.GuiceConfig</span>
</span><span class='line'><span class="s1">22:00:04,819 INFO  ~ Inicializando MyServiceImpl</span>
</span><span class='line'><span class="s1">22:00:04,824 INFO  ~ Inicializando MyDependentServiceImpl</span>
</span><span class='line'><span class="s1">22:00:04,824 INFO  ~ Application &#39;</span>lazySingleton<span class="err">&#39;</span> is now started !
</span></code></pre></td></tr></table></div></figure>


<p>Vaya, se volvieron a instanciar los singletons al iniciar la aplicación. ¿Será que el Stage no sirve para lo que creo? Vamos a probar con un test:</p>

<figure class='code'><figcaption><span>StageTest.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StageTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDevelopment</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">createInjector</span><span class="o">(</span><span class="n">Stage</span><span class="o">.</span><span class="na">DEVELOPMENT</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;development - antes del getInstance&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">MyService</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">MyService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;development - después del getInstance&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testProduction</span><span class="o">(){</span>
</span><span class='line'>        <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">createInjector</span><span class="o">(</span><span class="n">Stage</span><span class="o">.</span><span class="na">PRODUCTION</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;production - antes del getInstance&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">MyService</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">MyService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;production - después del getInstance&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Injector</span> <span class="nf">createInjector</span><span class="o">(</span><span class="n">Stage</span> <span class="n">stage</span><span class="o">){</span>
</span><span class='line'>        <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="n">stage</span><span class="o">,</span> <span class="k">new</span> <span class="n">AbstractModule</span><span class="o">(){</span>
</span><span class='line'>            <span class="nd">@Override</span>
</span><span class='line'>            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">bind</span><span class="o">(</span><span class="n">MyService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">MyServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">injector</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y el resultado es:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>INFO: development - antes del getInstance
</span><span class='line'>INFO: Inicializando MyServiceImpl
</span><span class='line'>INFO: development - después del getInstance
</span><span class='line'>
</span><span class='line'>INFO: Inicializando MyServiceImpl
</span><span class='line'>INFO: production - antes del getInstance
</span><span class='line'>INFO: production - después del getInstance
</span></code></pre></td></tr></table></div></figure>


<p>Como pone en la documentación, cuando se está en modo DEVELOPMENT los Singleton se inicializan de forma lazy.</p>

<p>¿Si esto funciona así, por qué cuando lo probé con el módulo de play no funcionó?</p>

<p>Revisando el código:</p>

<p><a href="">https://github.com/pk11/play-guice-module/blob/master/src/play/modules/guice/GuicePlugin.java</a></p>

<p>Encontré que lo que se hace en el @OnApplicationStart es buscar todas las clases que están anotadas con @InjectSupport las dependencias. Para inyectarlas hace un getBean de cada una. Aquí esta el problema, al hacer el getBean se instancia.</p>

<p>Buscando en internet encontré una solución a este problema:</p>

<p><a href="">https://groups.google.com/d/msg/google-guice/405HVgnCzsQ/fBUuueP6NfsJ</a></p>

<p>El código para permitir LazySingleton</p>

<ul>
<li><a href="https://github.com/wiregit/wirecode/blob/master/components/common/src/main/java/org/limewire/inject/LazySingleton.java">@LazySingleton</a></li>
<li><a href="https://github.com/wiregit/wirecode/blob/master/components/common/src/main/java/org/limewire/inject/MoreScopes.java">MoreScopes</a></li>
<li><a href="https://github.com/wiregit/wirecode/blob/master/components/common/src/main/java/org/limewire/inject/LazyBinder.java">LazyBinder</a></li>
</ul>


<p>Estas clases lo que hacen es que cuando se crea el inyector, crea un proxy para cada una de las clases que están anotadas como @LazySingleton. De forma que cuando inyecta los objetos lo que se inyecta en realidad es el proxy. La primera vez que se invoque un método de alguna de estas clases, el proxy se va a encargar de inicializar la clase.</p>

<p>La configuración del inyector quedaría así:</p>

<figure class='code'><figcaption><span>GuiceConfig.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GuiceConfig</span> <span class="kd">extends</span> <span class="n">GuiceSupport</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="n">Injector</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Stage</span> <span class="n">stage</span> <span class="o">=</span> <span class="n">Play</span><span class="o">.</span><span class="na">mode</span><span class="o">.</span><span class="na">isDev</span><span class="o">()</span> <span class="o">?</span> <span class="n">Stage</span><span class="o">.</span><span class="na">DEVELOPMENT</span> <span class="o">:</span> <span class="n">Stage</span><span class="o">.</span><span class="na">PRODUCTION</span><span class="o">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Guice</span><span class="o">.</span><span class="na">createInjector</span><span class="o">(</span><span class="n">stage</span><span class="o">,</span> <span class="k">new</span> <span class="n">AbstractModule</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="nd">@Override</span>
</span><span class='line'>            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">bindScope</span><span class="o">(</span><span class="n">LazySingleton</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MoreScopes</span><span class="o">.</span><span class="na">LAZY_SINGLETON</span><span class="o">);</span>
</span><span class='line'>                <span class="n">bindLazySingletonOnDev</span><span class="o">(</span><span class="n">MyService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MyServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>                <span class="n">bindLazySingletonOnDev</span><span class="o">(</span><span class="n">MyDependentService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MyDependentServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">protected</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="n">bindLazySingletonOnDev</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">expected</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">implClass</span><span class="o">){</span>
</span><span class='line'>                <span class="k">if</span><span class="o">(</span><span class="n">Play</span><span class="o">.</span><span class="na">mode</span><span class="o">.</span><span class="na">isDev</span><span class="o">()){</span>
</span><span class='line'>                    <span class="n">bind</span><span class="o">(</span><span class="n">implClass</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="n">MoreScopes</span><span class="o">.</span><span class="na">LAZY_SINGLETON</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">Provider</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">LazyBinder</span><span class="o">.</span><span class="na">newLazyProvider</span><span class="o">(</span><span class="n">expected</span><span class="o">,</span> <span class="n">implClass</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">bind</span><span class="o">(</span><span class="n">expected</span><span class="o">).</span><span class="na">toProvider</span><span class="o">(</span><span class="n">provider</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span><span class='line'>                    <span class="n">bind</span><span class="o">(</span><span class="n">expected</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">implClass</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="n">Scopes</span><span class="o">.</span><span class="na">SINGLETON</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cuando la aplicación está en modo desarrollo, las clases se instanciarán la primera vez que se llame a un método. Cuando usemos el modo producción, las clases se instanciarán cuando se inicie la aplicación.</p>

<p>Me queda pendiente añadir estas clases al fork para poder tener un módulo completo que se pueda reutilizar en todos los proyectos.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Axel Hernández Ferrera</span></span>

      








  


<time datetime="2012-02-02T22:18:00+00:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/guice/'>guice</a>, <a class='category' href='/blog/categories/java/'>java</a>, <a class='category' href='/blog/categories/playframework/'>playframework</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://axelhzf.github.com/blog/2012/02/02/play-framework-plus-google-guice/" data-via="axelhzf" data-counturl="http://axelhzf.github.com/blog/2012/02/02/play-framework-plus-google-guice/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <div class="meta row">
      
        <a class="basic-alignment left" href="/blog/2011/09/26/knockout-dot-js-ejemplo-completo/" title="Previous Post: knockout.js (Ejemplo completo)">&laquo; knockout.js (Ejemplo completo)</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/02/04/ampliando-el-modulo-de-google-guice/" title="Next Post: Ampliando el módulo de Google Guice">Ampliando el módulo de Google Guice &raquo;</a>
      
    </div>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  <footer role="contentinfo">
<div class="container">


    <div class="row">
        <div class="span3">
            <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/06/15/grunt-live-reload/">Grunt Live-Reload</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/30/labs-canvas-star-wars/">Labs : Canvas Star Wars</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/28/grunt-vs-wro4j/">Grunt vs Wro4j</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/27/grunt/">grunt</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/20/intellij-idea-keyboard-shortcuts/">IntelliJ Idea keyboard shortcuts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/20/octopress/">octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/04/ampliando-el-modulo-de-google-guice/">Ampliando el módulo de Google Guice</a>
      </li>
    
  </ul>
</section>

        </div>
        <div class="span5">
            
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("axelhzf", 6, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/axelhzf" class="twitter-follow-button" data-show-count="false">Follow @axelhzf</a>
  
</section>


        </div>
    </div>

    <hr>

    <div class="row">
        <ul class="main-navigation">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/tutorials">Tutorials</a></li>
    <li><a href="/talks">Talks</a></li>
    <li><a href="/experiments">Experiments</a></li>
    <li><a href="http://twitter.com/axelhzf" target="_blank">Twitter</a></li>
    <li><a href="http://www.github.com/axelhzf" target="_blank">Github</a></li>
    <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank">RSS</a></li>
</ul>

    </div>

    

    <div class="row license">
        This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a>.
        <br/>
        Axel Hernández Ferrera - Powered by <a href="http://octopress.org">Octopress</a>
    </div>

</div></footer>
  

<script type="text/javascript">
      var disqus_shortname = 'axelhzf';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://axelhzf.github.com/blog/2012/02/02/play-framework-plus-google-guice/';
        var disqus_url = 'http://axelhzf.github.com/blog/2012/02/02/play-framework-plus-google-guice/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
